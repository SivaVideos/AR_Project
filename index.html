<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wedding AR</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #config-panel {
        position: fixed; top: 10px; left: 10px;
        background: rgba(0,0,0,0.7); color: white;
        padding: 10px; border-radius: 10px;
        font-family: sans-serif; z-index: 999;
      }
      .badge {
        background: green; color: white;
        padding: 3px 6px; border-radius: 6px;
        font-size: 12px; text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="config-panel">
      <label><input type="checkbox" id="overrideToggle" /> Override Mode</label>
      <button id="stopAllBtn">Stop All Videos</button>
    </div>

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind;"
      color-space="sRGB"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets id="assets"></a-assets>
    </a-scene>

    <script>
      let activeTargetIndex = null;
      let overrideMode = false;

      const sceneEl = document.querySelector("a-scene");
      const assetsEl = document.querySelector("#assets");
      const stopAllBtn = document.querySelector("#stopAllBtn");
      const overrideToggle = document.querySelector("#overrideToggle");

      // Load config.json dynamically
      fetch("./config.json")
        .then(res => res.json())
        .then(config => {
          config.targets.forEach((target, index) => {
            // Add video asset
            const videoEl = document.createElement("video");
            videoEl.setAttribute("id", "video-" + index);
            videoEl.setAttribute("src", target.video);
            videoEl.setAttribute("preload", "auto");
            videoEl.setAttribute("playsinline", "");
            videoEl.setAttribute("webkit-playsinline", "");
            assetsEl.appendChild(videoEl);

            // Create target entity
            const entity = document.createElement("a-entity");
            entity.setAttribute("mindar-image-target", "targetIndex: " + index);

            // Video plane
            const plane = document.createElement("a-video");
            plane.setAttribute("src", "#video-" + index);
            plane.setAttribute("width", target.width || 1);
            plane.setAttribute("height", target.height || 0.6);
            plane.setAttribute("position", "0 0 0");
            entity.appendChild(plane);

            // Badge
            const badge = document.createElement("a-entity");
            badge.setAttribute("visible", "false");
            badge.setAttribute("geometry", "primitive: plane; height: 0.2; width: 0.6");
            badge.setAttribute("material", "color: green; opacity: 0.8");
            badge.setAttribute("text", "value: ðŸŽ¥ playing; align: center; color: white; width: 2");
            badge.setAttribute("position", "0 0.5 0");
            entity.appendChild(badge);

            sceneEl.appendChild(entity);

            // Events
            entity.addEventListener("targetFound", () => {
              if (!overrideMode && activeTargetIndex !== null && activeTargetIndex !== index) return;
              videoEl.play();
              badge.setAttribute("visible", "true");
              activeTargetIndex = index;
            });

            entity.addEventListener("targetLost", () => {
              videoEl.pause();
              badge.setAttribute("visible", "false");
              if (activeTargetIndex === index) activeTargetIndex = null;
            });
          });
        });

      // Override toggle
      overrideToggle.addEventListener("change", (e) => {
        overrideMode = e.target.checked;
      });

      // Stop All Videos button
      stopAllBtn.addEventListener("click", () => {
        document.querySelectorAll("video").forEach(v => v.pause());
        document.querySelectorAll("[text]").forEach(badge => {
          if (badge.getAttribute("text").value.includes("ðŸŽ¥")) {
            badge.setAttribute("visible", "false");
          }
        });
        activeTargetIndex = null;
      });
    </script>
  </body>
</html>
