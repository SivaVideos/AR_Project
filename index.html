<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wedding AR</title>

    <!-- A-Frame + MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      #config-panel {
        position: fixed; top: 10px; left: 10px;
        background: rgba(0,0,0,0.7); color: white;
        padding: 10px; border-radius: 10px;
        font-family: sans-serif; z-index: 999;
      }
      button {
        margin-top: 5px; display: block;
        background: #2196f3; color: white;
        border: none; border-radius: 5px;
        padding: 5px 10px; cursor: pointer;
      }
      button:hover { background: #0b7dda; }
    </style>
  </head>

  <body>
    <div id="config-panel">
      <button id="startBtn">Start AR</button>
      <label><input type="checkbox" id="overrideToggle" /> Override Mode</label>
      <button id="stopAllBtn">Stop All Videos</button>
      <button id="unmuteBtn">Unmute Videos</button>
    </div>

    <a-scene
      mindar-image="imageTargetSrc: https://SivaVideos.github.io/AR_Project/targets.mind;"
      color-space="sRGB"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets id="assets"></a-assets>
    </a-scene>

    <script>
      let activeTargetIndex = null;
      let overrideMode = false;
      let canUnmute = false;
      let videosLoaded = false;

      const sceneEl = document.querySelector("a-scene");
      const assetsEl = document.querySelector("#assets");
      const stopAllBtn = document.querySelector("#stopAllBtn");
      const overrideToggle = document.querySelector("#overrideToggle");
      const unmuteBtn = document.querySelector("#unmuteBtn");
      const startBtn = document.querySelector("#startBtn");

      let videoEls = [];

      // Load config.json
      fetch("https://SivaVideos.github.io/AR_Project/config.json")
        .then(res => {
          if (!res.ok) throw new Error("Config fetch failed");
          return res.json();
        })
        .then(config => {
          config.targets.forEach((target, index) => {
            // Add video asset
            const videoEl = document.createElement("video");
            videoEl.setAttribute("id", "video-" + index);
            videoEl.setAttribute("src", "https://SivaVideos.github.io/AR_Project/" + target.video);
            videoEl.setAttribute("preload", "auto");
            videoEl.setAttribute("playsinline", "");
            videoEl.setAttribute("webkit-playsinline", "");
            videoEl.setAttribute("muted", "true"); // initially muted
            videoEl.setAttribute("loop", "true");
            assetsEl.appendChild(videoEl);
            videoEls.push(videoEl);

            // Create target entity
            const entity = document.createElement("a-entity");
            entity.setAttribute("mindar-image-target", "targetIndex: " + index);

            // Video plane
            const plane = document.createElement("a-video");
            plane.setAttribute("src", "#video-" + index);
            plane.setAttribute("width", target.width || 1);
            plane.setAttribute("height", target.height || 0.6);
            plane.setAttribute("position", "0 0 0");
            entity.appendChild(plane);

            // Badge
            const badge = document.createElement("a-entity");
            badge.setAttribute("visible", "false");
            badge.setAttribute("geometry", "primitive: plane; height: 0.2; width: 0.6");
            badge.setAttribute("material", "color: green; opacity: 0.8");
            badge.setAttribute("text", "value: ðŸŽ¥ playing; align: center; color: white; width: 2");
            badge.setAttribute("position", "0 0.5 0");
            entity.appendChild(badge);

            sceneEl.appendChild(entity);

            // AR events
            entity.addEventListener("targetFound", () => {
              if (!overrideMode && activeTargetIndex !== null && activeTargetIndex !== index) return;

              // Stop all other videos
              videoEls.forEach(v => {
                if (v !== videoEl) { 
                  v.pause(); 
                  v.currentTime = 0;
                }
              });
              document.querySelectorAll("[text]").forEach(b => b.setAttribute("visible", "false"));

              // Play only the scanned video
              videoEl.currentTime = 0;
              if (canUnmute) videoEl.muted = false;
              videoEl.play().catch(e => console.error("Video play error:", e));

              badge.setAttribute("visible", "true");
              activeTargetIndex = index;
            });

            entity.addEventListener("targetLost", () => {
              videoEl.pause();
              badge.setAttribute("visible", "false");
              if (activeTargetIndex === index) activeTargetIndex = null;
            });
          });
          videosLoaded = true;
        })
        .catch(err => console.error("Config fetch error:", err.message));

      // Start AR button (must be clicked to enable video playback)
      startBtn.addEventListener("click", () => {
        if (!videosLoaded) return alert("Videos not yet loaded!");
        videoEls.forEach(v => v.play().then(() => v.pause())); // unlock videos via user gesture
        startBtn.style.display = "none"; // hide start button
        alert("AR initialized. Scan a target now.");
      });

      // Override toggle
      overrideToggle.addEventListener("change", e => { overrideMode = e.target.checked; });

      // Stop all videos
      stopAllBtn.addEventListener("click", () => {
        videoEls.forEach(v => v.pause());
        document.querySelectorAll("[text]").forEach(b => b.setAttribute("visible", "false"));
        activeTargetIndex = null;
      });

      // Unmute button
      unmuteBtn.addEventListener("click", () => {
        canUnmute = true;
        videoEls.forEach(v => v.muted = false);
        alert("Videos unmuted âœ…");
      });
    </script>
  </body>
</html>
