<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wedding AR</title>

    <!-- A-Frame + MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      #config-panel {
        position: fixed; top: 10px; left: 10px;
        background: rgba(0,0,0,0.7); color: white;
        padding: 10px; border-radius: 10px;
        font-family: sans-serif; z-index: 999;
      }
      .badge {
        background: green; color: white;
        padding: 3px 6px; border-radius: 6px;
        font-size: 12px; text-align: center;
      }
    </style>

    <!-- Console ‚Üí Alerts (mobile debugging) -->
    <script>
      (function() {
        const origLog = console.log, origError = console.error, origWarn = console.warn;
        console.log = (...args) => { origLog(...args); alert("[LOG] " + args.join(" ")); };
        console.error = (...args) => { origError(...args); alert("[ERROR] " + args.join(" ")); };
        console.warn = (...args) => { origWarn(...args); alert("[WARN] " + args.join(" ")); };
        window.onerror = (msg, src, line, col, err) => {
          alert("[UNCAUGHT ERROR] " + msg + " at " + src + ":" + line);
        };
      })();
    </script>
  </head>

  <body>
    <div id="config-panel">
      <label><input type="checkbox" id="overrideToggle" /> Override Mode</label>
      <button id="stopAllBtn">Stop All Videos</button>
    </div>

    <a-scene
      mindar-image="imageTargetSrc: https://YOUR-USERNAME.github.io/YOUR-REPO/targets.mind;"
      color-space="sRGB"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets id="assets"></a-assets>
    </a-scene>

    <script>
  let activeTargetIndex = null;
  let overrideMode = false;

  const sceneEl = document.querySelector("a-scene");
  const assetsEl = document.querySelector("a-assets");

  // ‚úÖ Load config.json dynamically
  fetch("./config.json")
    .then(res => {
      if (!res.ok) {
        alert("‚ùå config.json not found!");
        throw new Error("config.json missing");
      }
      return res.json();
    })
    .then(config => {
      alert("‚úÖ config.json loaded with " + config.targets.length + " targets");

      config.targets.forEach((target, index) => {
        // üé¨ Add video asset
        const videoEl = document.createElement("video");
        videoEl.setAttribute("id", "video-" + index);
        videoEl.setAttribute("src", target.video);
        videoEl.setAttribute("muted", "true"); // üî• required for autoplay
        videoEl.setAttribute("autoplay", "false");
        videoEl.setAttribute("preload", "auto");
        videoEl.setAttribute("playsinline", "");
        videoEl.setAttribute("webkit-playsinline", "");
        assetsEl.appendChild(videoEl);

        // üéØ Create target entity
        const entity = document.createElement("a-entity");
        entity.setAttribute("mindar-image-target", "targetIndex: " + index);

        // üñº Video plane
        const plane = document.createElement("a-video");
        plane.setAttribute("src", "#video-" + index);
        plane.setAttribute("width", target.width || 1);
        plane.setAttribute("height", target.height || 0.6);
        plane.setAttribute("position", "0 0 0");
        entity.appendChild(plane);

        // üéñ Green badge
        const badge = document.createElement("a-entity");
        badge.setAttribute("visible", "false");
        badge.setAttribute("geometry", "primitive: plane; height: 0.2; width: 0.6");
        badge.setAttribute("material", "color: green; opacity: 0.8");
        badge.setAttribute("text", "value: üé• playing; align: center; color: white; width: 2");
        badge.setAttribute("position", "0 0.5 0");
        entity.appendChild(badge);

        sceneEl.appendChild(entity);

        // üì° Events for AR detection
        entity.addEventListener("targetFound", () => {
          alert("‚úÖ Target " + index + " found!");
          if (!overrideMode && activeTargetIndex !== null && activeTargetIndex !== index) return;
          videoEl.play().catch(err => alert("‚ö†Ô∏è Video play failed: " + err.message));
          badge.setAttribute("visible", "true");
          activeTargetIndex = index;
        });

        entity.addEventListener("targetLost", () => {
          alert("‚ÑπÔ∏è Target " + index + " lost");
          videoEl.pause();
          badge.setAttribute("visible", "false");
          if (activeTargetIndex === index) activeTargetIndex = null;
        });
      });
    })
    .catch(err => {
      alert("‚ùå Error loading config.json: " + err.message);
    });
</script>
  </body>
</html>

